version: 0.1

phases:
  install:
    commands:
      - npm install
  pre_build:
    commands:
      - ensembl_version=$(curl -Sss 'https://rest.ensembl.org/info/data?' -H 'Content-type:text/xml' | grep 'releases' | sed -e 's/.*<releases>//' -e 's/<.*//')
      - ncbi_mapping_ensembl=$(curl -Sss 'ftp://ftp.ncbi.nih.gov/gene/DATA/README_ensembl' | grep 9606 | cut -f4)
      - gwas_catalog_version=$( curl -Sss -I 'https://www.ebi.ac.uk/gwas/api/search/downloads/alternative' | grep Content-Disposition | sed -e 's/.*gwas_catalog_//' -e 's/.tsv//')
      - gwas_catalog_ensembl=$( curl -Sss -I 'https://www.ebi.ac.uk/gwas/api/search/downloads/alternative' | grep Content-Disposition | sed -e 's/.*gwas_catalog_//' -e 's/.tsv//' | awk -F'_' '{ print $2 }' | tr -d 'e')
      - [[ "\$ncbi_mapping_ensembl" -eq "\$ensembl_version" ]] && echo "Matching Ensembl versions at NCBI"
      - [[ "\$gwas_catalog_ensembl" -eq "\$ensembl_version" ]] && echo "Matching Ensembl versions at GWAS catalog"
      - echo "\$ncbi_mapping_ensembl" > ensembl_version.txt
      - testversion 'gwas_associations.json' --static "\$gwas_catalog_version"
  build:
    commands:
      - ensembl_version=$(<ensembl_version.txt)
      - curl -O 'ftp://ftp.ncbi.nih.gov/gene/DATA/gene2ensembl.gz'
      - gunzip gene2ensembl.gz
      - ./bin/download_exons.sh \$ensembl_version
      - curl 'https://www.ebi.ac.uk/gwas/api/search/downloads/alternative' > associations.tsv
      - (head -1 associations.tsv; tail -n+2 associations.tsv | sort -n -k 12 -k 13) > sorted_gwas.tsv
      - node js/index.js
      - mkdir -p dist
      - cp mapped.json dist/gwas_associations.json
  post_build:
    commands:
      - echo "Skipping post_build"
artifacts:
  files:
    - dist